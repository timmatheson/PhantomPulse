/**
 * Created with JetBrains WebStorm.
 * User: kaven276
 * Date: 13-5-21
 * Time: 上午10:03
 */

var net = require('net')
  , Socket = net.Socket
  , port = 80
  , ip80 = []
  ;


function connect(host){
  var socket = new Socket()
    ;

  socket.on('connect', function(){

    console.log('connect ok', host);
    ip80.push(host);

    // socket.setTimeout(5000);
    socket.on('timeout', function(){
      console.log("NO.%d idle timeout", id);
      socket.destroy();
    });

    socket.on('end', function(data){
      socket.destroy();
    });

  });

  socket.on('error', function(err){
    console.log("NO.%s", host, err);
    socket.destroy();
  });

  socket.connect(port, host);
  console.log('try connect %s', host);
}

function scan(prefix){
  for (var i = 1; i < 255; i++) {
    connect(prefix + '.' + i);
  }
}

scan('60.29.143');

var exec = require('child_process').exec,
  child;

setTimeout(function(){
  child = exec('arp -an | grep -c "(incomplete)"',
    function(error, stdout, stderr){
      console.log('free ip: ' + stdout);
      if (error !== null) {
        console.log('exec error: ' + error);
      }
    });
  child = exec('arp -an | grep -c -v "(incomplete)"',
    function(error, stdout, stderr){
      console.log('used ip: ' + stdout);
      if (error !== null) {
        console.log('exec error: ' + error);
      }
    });
  setTimeout(function(){
    console.log(ip80);
  }, 1000);
}, 3000);
